<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Parcel 3D Fixed</title>
<script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>
<style>
body{margin:0;background:#000;color:#fff;font-family:sans-serif}
video,canvas{position:absolute;top:0;left:0;width:100vw;height:100vh;object-fit:cover}
#ui{
position:absolute;
top:10px;
left:10px;
background:rgba(0,0,0,.75);
padding:12px;
border-radius:10px;
white-space:pre;
}
</style>
</head>
<body>

<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>
<div id="ui">Lade OpenCV...</div>

<script>

let video, canvas, ctx;

let objectPoints, imagePoints;
let cameraMatrix, distCoeffs;
let calibrated = false;
let calibrationFrames = 0;

let currentRvec, currentTvec;

const A4_W = 21.0;
const A4_H = 29.7;

function startApp(){

video = document.getElementById("video");
canvas = document.getElementById("canvas");
ctx = canvas.getContext("2d");

objectPoints = new cv.MatVector();
imagePoints = new cv.MatVector();

initCamera();

}

function initCamera(){

navigator.mediaDevices.getUserMedia({
video:{facingMode:"environment",width:{ideal:1280}}
}).then(stream=>{
video.srcObject=stream;
video.play();
video.onloadedmetadata=()=>{
canvas.width=video.videoWidth;
canvas.height=video.videoHeight;
requestAnimationFrame(loop);
};
});

}

function loop(){

ctx.drawImage(video,0,0,canvas.width,canvas.height);
let src = cv.imread(canvas);

if(!calibrated){
detectCalibration(src);
}else{
estimatePose(src);
}

src.delete();
requestAnimationFrame(loop);

}

function detectCalibration(src){

let gray=new cv.Mat();
let edges=new cv.Mat();
let contours=new cv.MatVector();
let hierarchy=new cv.Mat();

cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
cv.GaussianBlur(gray,gray,new cv.Size(5,5),0);
cv.Canny(gray,edges,50,150);

cv.findContours(edges,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

for(let i=0;i<contours.size();i++){

let cnt=contours.get(i);
let approx=new cv.Mat();

cv.approxPolyDP(cnt,approx,0.02*cv.arcLength(cnt,true),true);

if(approx.rows===4 && cv.contourArea(cnt)>40000){

let imgPts=cv.matFromArray(4,1,cv.CV_32FC2,approx.data32S);
let objPts=cv.matFromArray(4,1,cv.CV_32FC3,[
0,0,0,
A4_W,0,0,
A4_W,A4_H,0,
0,A4_H,0
]);

imagePoints.push_back(imgPts);
objectPoints.push_back(objPts);

calibrationFrames++;

document.getElementById("ui").innerText =
"Kalibrierung: "+calibrationFrames+"/15";

if(calibrationFrames>=15){
calibrateCamera();
}

approx.delete();
break;
}

approx.delete();
}

gray.delete(); edges.delete(); contours.delete(); hierarchy.delete();

}

function calibrateCamera(){

cameraMatrix = new cv.Mat();
distCoeffs = new cv.Mat();

let rvecs=new cv.MatVector();
let tvecs=new cv.MatVector();

cv.calibrateCamera(
objectPoints,
imagePoints,
new cv.Size(canvas.width,canvas.height),
cameraMatrix,
distCoeffs,
rvecs,
tvecs
);

calibrated=true;

document.getElementById("ui").innerText =
"Kalibrierung abgeschlossen.\nTippe obere Kante.";

}

function estimatePose(src){

let gray=new cv.Mat();
let edges=new cv.Mat();
let contours=new cv.MatVector();
let hierarchy=new cv.Mat();

cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
cv.Canny(gray,edges,50,150);
cv.findContours(edges,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

for(let i=0;i<contours.size();i++){

let cnt=contours.get(i);
let approx=new cv.Mat();

cv.approxPolyDP(cnt,approx,0.02*cv.arcLength(cnt,true),true);

if(approx.rows===4 && cv.contourArea(cnt)>40000){

let imgPts=cv.matFromArray(4,1,cv.CV_32FC2,approx.data32S);
let objPts=cv.matFromArray(4,1,cv.CV_32FC3,[
0,0,0,
A4_W,0,0,
A4_W,A4_H,0,
0,A4_H,0
]);

currentRvec=new cv.Mat();
currentTvec=new cv.Mat();

cv.solvePnP(objPts,imgPts,cameraMatrix,distCoeffs,currentRvec,currentTvec);

approx.delete();
break;
}

approx.delete();
}

gray.delete(); edges.delete(); contours.delete(); hierarchy.delete();

}

canvas?.addEventListener("click", function(e){

if(!currentRvec) return;

let rect=canvas.getBoundingClientRect();
let x=(e.clientX-rect.left)*(canvas.width/rect.width);
let y=(e.clientY-rect.top)*(canvas.height/rect.height);

let height = computeHeightFromImagePoint(x,y);

document.getElementById("ui").innerText =
"HÃ¶he: "+height.toFixed(2)+" cm";

});

function computeHeightFromImagePoint(u,v){

let invCam=cameraMatrix.inv();

let uv1=cv.matFromArray(3,1,cv.CV_64F,[u,v,1.0]);
let temp=new cv.Mat();

cv.gemm(invCam,uv1,1,new cv.Mat(),0,temp);

let R=new cv.Mat();
cv.Rodrigues(currentRvec,R);

let Rinv=R.inv();

let world=new cv.Mat();
cv.gemm(Rinv,temp,1,currentTvec,-1,world);

return Math.abs(world.doubleAt(2,0));

}

cv.onRuntimeInitialized = startApp;

</script>
</body>
</html>
